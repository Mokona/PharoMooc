% By Luc Fabresse, 2015
% fork of MoocLab Inria beamer style
\mode<presentation>

% Title page
\defbeamertemplate*{title page}{MoocLab}[1][]
{
\begin{textblock*}{0px}(\paperwidth-4cm,0.5cm)%
\includegraphics[width=3.5cm]{pharoMOOCLogo}
\end{textblock*}%

    \bigskip
	 \bigskip
  \usebeamerfont{title}\usebeamercolor[fg]{title}\inserttitle\par
    \bigskip
  
  \usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par
  \bigskip
  \bigskip
  
  \usebeamerfont{author}\usebeamercolor[fg]{author}\insertauthor\par
  \bigskip
  
  \usebeamerfont{date}\usebeamercolor[fg]{date}\insertdate\par
  \bigskip
}

\setbeamertemplate{blocks}[rounded][shadow=false]              % pour des blocks arrondis
\setbeamercolor{block body alerted}{fg=white,bg=MoocLab-red} 

% Navigation symbols
\defbeamertemplate*{navigation symbols}{MoocLab}
{%
  \hbox{%
    \hbox{\insertslidenavigationsymbol}
    \hbox{\insertframenavigationsymbol}
    \hbox{\insertsubsectionnavigationsymbol}
    \hbox{\insertsectionnavigationsymbol}
    \hbox{\insertdocnavigationsymbol}
    \hbox{\insertbackfindforwardnavigationsymbol}%
  }%
}

% No navigation symbols in handout or trans mode:
\only<handout| trans>{\setbeamertemplate{navigation symbols}{}}


% Section and subsections in head/foot
\defbeamertemplate*{section in head/foot}{MoocLab}
{\insertsectionhead}

\defbeamertemplate*{section in head/foot shaded}{MoocLab}[1][50]
{\color{fg!#1!bg}\usebeamertemplate{section in head/foot}}

\defbeamertemplate*{subsection in head/foot}{MoocLab}
{\insertsubsectionhead}

\defbeamertemplate*{subsection in head/foot shaded}{MoocLab}[1][50]
{\color{fg!#1!bg}\usebeamertemplate{subsection in head/foot}}

\defbeamertemplate*{subsubsection in head/foot}{MoocLab}
{\insertsubsubsectionhead}

\defbeamertemplate*{subsubsection in head/foot shaded}{MoocLab}[1][50]
{\color{fg!#1!bg}\usebeamertemplate{subsubsection in head/foot}}





% Headline and footline

% \defbeamertemplate*{headline}{MoocLab}
% {}

% \setbeamertemplate{headline}{%
% % \leavevmode%
% \usebeamerfont{author in head/foot}
% \footnotesize
% \vspace{2ex}
% \hfill\insertframenumber{}\hspace{2ex}
% \vspace{-4ex}
% }

\setbeamertemplate{headline}{%
	\vspace*{5px}
	\hfill\begin{minipage}{45px}
\raggedright
\hspace{3px}\includegraphics[height=14px]{pharoLogo}\\
\includegraphics[height=16px]{inria}
	\end{minipage}
	\vspace*{-38px}
}

\newcounter{pagecount}
\addtocounter{pagecount}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section{A counter that contains the number of pages}
% \DescribeMacro{\bs@savelastpage}
% Write number of pages into aux file
% We need two runs for this to work
%    \begin{MacroCode}
\newcommand{\bs@savelastpage}{%
  \immediate\write\@auxout{%
    \string\message{bstransp: Loading lastpage from aux file}%
    \string\setcounter{pagecount}{\thepage}}}
%    \end{MacroCode}
%
% At the end of the document start the save procedure
% and utter a message.
%    \begin{MacroCode}
\AtEndDocument{%
  \message{bstransp: Saving set lastpage into aux file}%
  \bs@savelastpage}
%    \end{MacroCode}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{fp}               % FLoating point calc
\edef\midpoint{0.5}%

\newlength{\footrest}
\newlength{\leftfoot}
\newlength{\rightfoot}
\newlength{\minleftfoot}
\newlength{\minrightfoot}
\newlength{\pharowidth}
\newlength{\mingradientfoot}

\setlength{\mingradientfoot}{0px}
\setlength{\pharowidth}{0.48cm}
\setlength{\minleftfoot}{1.6cm}% taille à laisser à gauche
\setlength{\minrightfoot}{0.5cm}% taille à laisser à droite

\newlength{\mypaperwidth}
\setlength{\mypaperwidth}{\paperwidth}
\addtolength{\mypaperwidth}{-\videowidth}%

\usefoottemplate{%
% \setbeamertemplate{footline}{
  % \settowidth{\minleftfoot}{\tiny\@bottomlefttext} % taille à laisser à gauche
  \setlength{\footrest}{\mypaperwidth}%
  \addtolength{\footrest}{-\pharowidth}%
  \addtolength{\footrest}{-\minleftfoot}%
  \addtolength{\footrest}{-\minrightfoot}%
  \addtolength{\footrest}{-2\mingradientfoot}%
  \ifthenelse{\equal{\thepagecount}{1}}{}{%
    \FPeval{\midpoint}{trunc(((thepage-1) / (thepagecount-2)):4)}%
  }%
  \setlength{\leftfoot}{0cm}%
  \setlength{\rightfoot}{\footrest}%
  \addtolength{\leftfoot}{\midpoint\footrest}%
  \addtolength{\rightfoot}{-\leftfoot}%
  \addtolength{\leftfoot}{\mingradientfoot}%
  \addtolength{\rightfoot}{\mingradientfoot}%
  \vbox{\tiny%
    \hbox{%
	 
      \setbox\beamer@linebox=\hbox to \mypaperwidth {%
        {\hskip 0.5em\tiny\color{white}\textbf{\@bottomlefttext}\hfill\hskip 1em{\textbf\insertframenumber}\hskip 0.7em}}%
		  
      \ht\beamer@linebox=2.125ex%
      \dp\beamer@linebox=0pt%
      \setbox\beamer@linebox=\vbox{\box\beamer@linebox\vskip0.9ex}%
      \hskip-\Gm@lmargin%

      \pgfdeclarehorizontalshading{leftfootshade}{\paperheight}{%
        color(0pt)=(white!50!Pharo-blue);%
        color(\leftfoot)=(white)}%
		  
      \pgfdeclarehorizontalshading{rightfootshade}{\paperheight}{%
        color(0pt)=(white);%
        color(\rightfoot)=(white!50!Pharo-blue)}%
		   
		% background color text on the left
      \color{white!50!Pharo-blue}\vrule width \minleftfoot height\ht\beamer@linebox%
		
		% background color before logo
      \begin{pgfpicture}{0pt}{0pt}{\leftfoot}{\ht\beamer@linebox}%
        \pgfrect[clip]{\pgforigin}{\pgfpoint{\leftfoot}{\ht\beamer@linebox}}%
        \pgfbox[left,base]{\pgfuseshading{leftfootshade}}%
      \end{pgfpicture}%

		% logo		
      \includegraphics[width=\pharowidth]{icon-pharo} % le curseur de page 
      
		% background color after logo
		\begin{pgfpicture}{0pt}{0pt}{\rightfoot}{\ht\beamer@linebox}%
        \pgfrect[clip]{\pgforigin}{\pgfpoint{\rightfoot}{\ht\beamer@linebox}}%
        \pgfbox[left,base]{\pgfuseshading{rightfootshade}}%
      \end{pgfpicture}%
      
		\color{white!50!Pharo-blue}\vrule width \minrightfoot height\ht\beamer@linebox%
		
      \hskip-\mypaperwidth%
      
		\hbox{\box\beamer@linebox\hfill}\hfill\hskip-\Gm@rmargin%
    }%
  }%
}


% background

\defbeamertemplate*{background}{MoocLab}
{

}


\defbeamertemplate*{background canvas}{MoocLab}
{%
  \ifbeamercolorempty[bg]{background canvas}{}{\color{bg}\vrule width\paperwidth height\paperheight}%

 \begin{beamercolorbox}[wd=0.13\paperwidth,ht=8ex,dp=3ex,center]{author in head/foot}

   %Affichage zone réservée
   \insertSpaceForVideo
  \end{beamercolorbox}
}


% Sidebar

\defbeamertemplate*{sidebar left}{MoocLab}
{}

\defbeamertemplate*{sidebar right}{MoocLab}
{
  \vfill%
  \llap{\insertlogo\hskip0.1cm}%
  \vskip2pt%
  \llap{\usebeamertemplate***{navigation symbols}\hskip0.1cm}%
  \vskip2pt%
}

\defbeamertemplate*{sidebar canvas left}{MoocLab}
{%
  \ifbeamercolorempty[bg]{sidebar left}{}
  {\color{bg}\vrule height\sidebarheight width\beamer@leftsidebar}%
}

\defbeamertemplate*{sidebar canvas right}{MoocLab}
{%
  \ifbeamercolorempty[bg]{sidebar right}{}
  {\color{bg}\vrule height\sidebarheight width\beamer@rightsidebar}%
}



% Frame title: MoocLab

\defbeamertemplate*{frametitle}{MoocLab}[1][left]
{
  \ifbeamercolorempty[bg]{frametitle}{}{\nointerlineskip}%
  \@tempdima=\textwidth%
  \advance\@tempdima by\beamer@leftmargin%
  \advance\@tempdima by\beamer@rightmargin%
  \begin{beamercolorbox}[sep=0.3cm,#1,wd=\the\@tempdima]{frametitle}
    \usebeamerfont{frametitle}%
    \vbox{}\vskip-1ex%
    \if@tempswa\else\csname beamer@fte#1\endcsname\fi%
    \strut\insertframetitle\strut\par%
    {%
      \ifx\insertframesubtitle\@empty%
      \else%
      {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}%
      \fi
    }%
    \vskip-1ex%
    \if@tempswa\else\vskip-.3cm\fi% set inside beamercolorbox... evil here...
  \end{beamercolorbox}%
}

\def\beamer@fteright{\vskip0.35cm\advance\leftskip by 1.7cm\advance\rightskip by1.7cm}


% Frame title continuations, MoocLab

\defbeamertemplate*{frametitle continuation}{MoocLab}{\insertcontinuationcountroman}



% Notes

\defbeamertemplate*{note page}{MoocLab}
{%
  {%
    \scriptsize
    \usebeamerfont{note title}\usebeamercolor[fg]{note title}%
    \ifbeamercolorempty[bg]{note title}{}{%
      \insertvrule{.25\paperheight}{note title.bg}%
      \vskip-.25\paperheight%
      \nointerlineskip%
    }%
    \vbox{
      \hfill\insertslideintonotes{0.25}\hskip-\Gm@rmargin\hskip0pt%
      \vskip-0.25\paperheight%
      \nointerlineskip
      \begin{pgfpicture}{0cm}{0cm}{0cm}{0cm}
        \begin{pgflowlevelscope}{\pgftransformrotate{90}}
          {\pgftransformshift{\pgfpoint{-2cm}{0.2cm}}%
          \pgftext[base,left]{\usebeamerfont{note date}\usebeamercolor[fg]{note date}\the\year-\ifnum\month<10\relax0\fi\the\month-\ifnum\day<10\relax0\fi\the\day}}
        \end{pgflowlevelscope}
      \end{pgfpicture}}
    \nointerlineskip
    \vbox to .25\paperheight{\vskip0.5em
      \hbox{\insertshorttitle[width=8cm]}%
      \setbox\beamer@tempbox=\hbox{\insertsection}%
      \hbox{\ifdim\wd\beamer@tempbox>1pt{\hskip4pt\raise3pt\hbox{\vrule
            width0.4pt height7pt\vrule width 9pt
            height0.4pt}}\hskip1pt\hbox{\begin{minipage}[t]{7.5cm}\def\breakhere{}\insertsection\end{minipage}}\fi%
      }%
      \setbox\beamer@tempbox=\hbox{\insertsubsection}%
      \hbox{\ifdim\wd\beamer@tempbox>1pt{\hskip17.4pt\raise3pt\hbox{\vrule
            width0.4pt height7pt\vrule width 9pt
            height0.4pt}}\hskip1pt\hbox{\begin{minipage}[t]{7.5cm}\def\breakhere{}\insertsubsection\end{minipage}}\fi%
      }%
      \setbox\beamer@tempbox=\hbox{\insertshortframetitle}%
      \hbox{\ifdim\wd\beamer@tempbox>1pt{\hskip30.8pt\raise3pt\hbox{\vrule
            width0.4pt height7pt\vrule width 9pt
            height0.4pt}}\hskip1pt\hbox{\insertshortframetitle[width=7cm]}\fi%
      }%
      \vfil}%
  }%
  \ifbeamercolorempty[bg]{note page}{}{%
    \nointerlineskip%
    \insertvrule{.75\paperheight}{note page.bg}%
    \vskip-.75\paperheight%
  }%
  \vskip.25em
  \nointerlineskip
  \insertnote
}

\mode<all>
